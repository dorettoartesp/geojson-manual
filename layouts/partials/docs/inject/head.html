<!-- Custom code copy button styles and script -->
<style>
/* Center Mermaid diagrams */
.mermaid {
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 1.5em 0;
}

.mermaid svg {
  max-width: 100%;
  height: auto;
}
.book-code-wrapper {
  position: relative;
  width: 100%;
  max-width: 100%;
  margin-top: 0.1rem;
  padding-top: 0.2rem;
}

.book-code-scroll {
  overflow-x: auto;
  overflow-y: hidden;
}

.book-code-scroll .highlight,
.book-code-scroll pre {
  margin: 0;
}

.book-code-copy-button {
  position: absolute;
  top: calc(-1 * var(--book-code-copy-offset, 0.85rem));
  right: 0.5rem;
  padding: 6px 12px;
  background-color: rgba(68, 138, 255, 0.85);
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  opacity: 1; /* Sempre visível */
  transition: background-color 0.2s;
  z-index: 10;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.book-code-copy-button:hover {
  background-color: rgba(68, 138, 255, 1);
}

.book-code-copy-button.copied {
  background-color: rgba(46, 204, 113, 0.85);
}

.book-code-copy-button.copied:hover {
  background-color: rgba(46, 204, 113, 1);
}

/* Dark mode adjustments */
.book-theme-dark .book-code-copy-button {
  background-color: rgba(68, 138, 255, 0.9);
}

.book-theme-dark .book-code-copy-button.copied {
  background-color: rgba(46, 204, 113, 0.9);
}
</style>

<script>
(function() {
  'use strict';

  const copyButtonUpdaters = [];

  if (!navigator.clipboard) {
    console.warn('Clipboard API not available');
    return;
  }

  function createCopyButton() {
    const button = document.createElement('button');
    button.className = 'book-code-copy-button';
    button.textContent = 'Copiar';
    button.setAttribute('aria-label', 'Copiar código');
    return button;
  }

  function wrapBlock(element) {
    if (!element || !element.parentElement) {
      return null;
    }

    if (element.closest('.book-code-wrapper')) {
      return element.closest('.book-code-wrapper');
    }

    const wrapper = document.createElement('div');
    wrapper.className = 'book-code-wrapper';

    const scroll = document.createElement('div');
    scroll.className = 'book-code-scroll';

    const parent = element.parentElement;
    parent.insertBefore(wrapper, element);
    wrapper.appendChild(scroll);
    scroll.appendChild(element);

    return wrapper;
  }

  function scheduleButtonAlignment(wrapper, button) {
    function updatePosition() {
      const previous = wrapper.previousElementSibling;
      const reference = previous || wrapper;

      if (!reference || !reference.getBoundingClientRect) {
        button.style.setProperty('--book-code-copy-offset', '0.75rem');
        return;
      }

      const existingOffset = button.style.getPropertyValue('--book-code-copy-offset');
      button.style.setProperty('--book-code-copy-offset', '0px');

      const referenceRect = reference.getBoundingClientRect();
      const wrapperRect = wrapper.getBoundingClientRect();
      const buttonRect = button.getBoundingClientRect();

      const referenceCenter = referenceRect.top + referenceRect.height / 2;
      const buttonHalf = buttonRect.height / 2;
      const offset = wrapperRect.top - referenceCenter + buttonHalf;

      const finalOffset = Math.max(offset, 8);
      button.style.setProperty('--book-code-copy-offset', `${finalOffset}px`);

      if (existingOffset) {
        requestAnimationFrame(() => {
          button.style.setProperty('--book-code-copy-offset', `${finalOffset}px`);
        });
      }
    }

    copyButtonUpdaters.push(updatePosition);
    requestAnimationFrame(updatePosition);
  }

  function addCopyButtons() {
    const blocks = document.querySelectorAll('div.highlight, pre');

    blocks.forEach(function(block) {
      if (block.tagName === 'PRE' && block.closest('.highlight')) {
        return; // handled by the parent highlight
      }

      const codeElement = block.querySelector('code') || block;
      const wrapper = wrapBlock(block);

      if (!wrapper || wrapper.querySelector('.book-code-copy-button')) {
        return;
      }

      const button = createCopyButton();

      button.addEventListener('click', function() {
        const code = codeElement.textContent || codeElement.innerText;

        navigator.clipboard.writeText(code).then(function() {
          button.textContent = 'Copiado!';
          button.classList.add('copied');

          setTimeout(function() {
            button.textContent = 'Copiar';
            button.classList.remove('copied');
          }, 2000);
        }).catch(function(err) {
          console.error('Failed to copy:', err);
          button.textContent = 'Erro';

          setTimeout(function() {
            button.textContent = 'Copiar';
          }, 2000);
        });
      });

      wrapper.appendChild(button);
      scheduleButtonAlignment(wrapper, button);
    });
  }

  // Run when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', addCopyButtons);
  } else {
    addCopyButtons();
  }

  window.addEventListener('resize', () => {
    copyButtonUpdaters.forEach((update) => requestAnimationFrame(update));
  });
})();
</script>
