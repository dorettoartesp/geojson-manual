---
title: "6.5. Exportar, Ajustar e Validar"
weight: 65
bookToc: true
---

## **6.5 Passo 4: Exportar para GeoJSON (QGIS)**

**üìã Este passo se aplica a:**
- ‚úÖ [**Op√ß√£o 1** (F√≥rmula Excel)]({{< relref "06.1-metodo-excel" >}}) - Voc√™ importou CSV com WKT no QGIS
- ‚úÖ [**Op√ß√£o 2** (WKT Manual)]({{< relref "06.2-metodo-wkt" >}}) - Voc√™ importou CSV com WKT no QGIS
- ‚úÖ [**Op√ß√£o 3** (QGIS Desenho Manual)]({{< relref "06.3-metodo-qgis" >}}) - Voc√™ desenhou geometrias em GeoPackage/Shapefile
- ‚ùå [**Op√ß√£o 4** (ogr2ogr)]({{< relref "06.4-metodo-ogr2ogr" >}}) - Pule direto para **Se√ß√£o 6.6**

---

Agora voc√™ tem uma camada com geometrias no QGIS e precisa export√°-la como GeoJSON.

---

## **A. Tratamento de M√∫ltiplas Camadas com Geometrias Diferentes**

**üìã Esta se√ß√£o se aplica a voc√™ SE:**
- ‚úÖ Criou **m√∫ltiplas camadas** no QGIS (Point, LineString, Polygon separados)
- ‚úÖ Seus servi√ßos t√™m **tipos de geometria diferentes**
- ‚úÖ Precisa combinar essas camadas em **um √∫nico arquivo GeoJSON**

**‚ùå Se voc√™ tem apenas UMA camada:**
- Pule esta se√ß√£o e v√° direto para [Se√ß√£o B - Exportar](#b-exportar)

---

### **Por que preciso combinar arquivos?**

**Limita√ß√£o do QGIS:**
- Cada camada GeoPackage/Shapefile suporta **apenas UM tipo de geometria**
- Se voc√™ tem Point + LineString + Polygon, precisou criar 3 camadas separadas
- Ao exportar, o QGIS gera **UM arquivo GeoJSON por camada**

**Exig√™ncia do Schema:**
- O arquivo final deve ser **UM √öNICO GeoJSON** contendo TODAS as features
- O schema permite geometrias mistas (Point, LineString, Polygon, MultiPoint) no mesmo FeatureCollection

**Solu√ß√£o:**
- Exportar cada camada separadamente
- Combinar os arquivos usando o script `mesclar_geojson.py`

---

### **Fluxograma do Processo**

```mermaid
flowchart TD
    Start["Voc√™ tem m√∫ltiplas<br/>camadas no QGIS"]

    Layer1["Camada 1: Points<br/>(equipamentos)"]
    Layer2["Camada 2: LineStrings<br/>(pavimenta√ß√£o)"]
    Layer3["Camada 3: Polygons<br/>(√°reas SAU)"]

    Export1["Exportar Camada 1<br/>‚Üí L13_points_TEMP.geojson"]
    Export2["Exportar Camada 2<br/>‚Üí L13_lines_TEMP.geojson"]
    Export3["Exportar Camada 3<br/>‚Üí L13_polygons_TEMP.geojson"]

    Script["Script Python:<br/>mesclar_geojson.py"]

    Final["Arquivo Final:<br/>L13_conservacao_2026_R0.geojson"]

    Validate["Validar com<br/>validar_geojson.py"]

    Start --> Layer1
    Start --> Layer2
    Start --> Layer3

    Layer1 --> Export1
    Layer2 --> Export2
    Layer3 --> Export3

    Export1 --> Script
    Export2 --> Script
    Export3 --> Script

    Script --> Final
    Final --> Validate

    style Start fill:#e1f5ff
    style Script fill:#fff4e1
    style Final fill:#e7f9e7
    style Validate fill:#e7f9e7
```

---

### **Passo a Passo: Exportar e Combinar**

#### **1. Exportar cada camada separadamente**

Para cada camada que voc√™ criou (Points, LineStrings, Polygons):

1. **Selecione a camada** no painel de camadas
2. **Bot√£o direito** ‚Üí **"Exportar ‚Üí Salvar Fei√ß√µes Como..."**
3. **Configure:**
   - **Formato**: GeoJSON
   - **Nome do arquivo**: Use sufixo identificando o tipo
     - `L13_conservacao_points_TEMP.geojson`
     - `L13_conservacao_lines_TEMP.geojson`
     - `L13_conservacao_polygons_TEMP.geojson`
   - **SRC**: EPSG:4674 - SIRGAS 2000
   - **Precis√£o**: 6 casas decimais
   - **Codifica√ß√£o**: UTF-8
4. Clique **OK**

üí° **Dica:** Use sufixo `_TEMP` para indicar que s√£o arquivos tempor√°rios que ser√£o mesclados.

**Repita para todas as camadas.**

---

#### **2. Combinar os arquivos com o script Python**

**Requisitos:**
- Python 3.6+ instalado
- Script `mesclar_geojson.py` (dispon√≠vel em `/scripts` do projeto)

**Comando:**

```bash
python scripts/mesclar_geojson.py \
    L13_conservacao_points_TEMP.geojson \
    L13_conservacao_lines_TEMP.geojson \
    L13_conservacao_polygons_TEMP.geojson \
    -o L13_conservacao_2026_R0.geojson
```

**Ajuste conforme seu caso:**
- Adicione ou remova arquivos conforme necess√°rio
- Use o nome final correto (`L[n√∫mero]_conservacao_2026_R0.geojson` ou `L[n√∫mero]_obras_2026_R0.geojson`)

**O que o script faz:**
- ‚úÖ Combina todas as features em um √∫nico FeatureCollection
- ‚úÖ Verifica IDs duplicados e emite avisos
- ‚úÖ Adiciona CRS (EPSG:4674)
- ‚úÖ Adiciona metadata (schema_version: R0, data_geracao)
- ‚úÖ Preserva todos os atributos das features originais

**Exemplo de sa√≠da:**

```
======================================================================
  Mesclagem de Arquivos GeoJSON
======================================================================

üìÇ Arquivos de entrada: 3

[1/3] Processando: L13_conservacao_points_TEMP.geojson
------------------------------------------------------------
‚úÖ 15 features extra√≠das:
   - Point: 15

[2/3] Processando: L13_conservacao_lines_TEMP.geojson
------------------------------------------------------------
‚úÖ 8 features extra√≠das:
   - LineString: 8

[3/3] Processando: L13_conservacao_polygons_TEMP.geojson
------------------------------------------------------------
‚úÖ 3 features extra√≠das:
   - Polygon: 3

======================================================================
üìä Resumo da Mesclagem
======================================================================
Total de features: 26
Tipos de geometria:
  - LineString: 8
  - Point: 15
  - Polygon: 3

Verificando unicidade dos IDs...
IDs √∫nicos: 26

‚úÖ Arquivo mesclado salvo com sucesso!
üìÅ Arquivo de sa√≠da: L13_conservacao_2026_R0.geojson
üìè Tamanho: 45.2 KB

======================================================================
‚úÖ Pr√≥ximo passo: Validar com validar_geojson.py
======================================================================
```

---

#### **3. Deletar arquivos tempor√°rios**

Ap√≥s confirmar que o arquivo mesclado foi criado corretamente:

```bash
rm L13_conservacao_points_TEMP.geojson
rm L13_conservacao_lines_TEMP.geojson
rm L13_conservacao_polygons_TEMP.geojson
```

Ou no Windows:
```cmd
del L13_conservacao_points_TEMP.geojson
del L13_conservacao_lines_TEMP.geojson
del L13_conservacao_polygons_TEMP.geojson
```

---

#### **4. Prosseguir para ajustes e valida√ß√£o**

Agora voc√™ tem **UM √öNICO arquivo GeoJSON** contendo todas as features.

‚û°Ô∏è Continue para [Se√ß√£o B - Remover Colunas Auxiliares](#b-remover-colunas-auxiliares-se-necess√°rio) se necess√°rio.

‚û°Ô∏è Ou pule direto para [Se√ß√£o 6.6 - Adicionar Metadados](#66-passo-5-adicionar-metadados-e-ajustar-formato).

---

### **‚ö†Ô∏è Problemas Comuns**

**IDs duplicados entre camadas:**
- Se o script reportar IDs duplicados, verifique se voc√™ n√£o repetiu IDs entre as camadas
- Cada feature precisa ter um ID √∫nico em TODO o arquivo final
- Corrija no QGIS (tabela de atributos) e re-exporte

**Erro "File not found":**
- Certifique-se de estar no diret√≥rio correto
- Use caminhos absolutos ou relativos corretos
- No Windows, use barras duplas `\\` ou barras normais `/`

**Script n√£o encontrado:**
- Baixe o script do Portal de Dados Abertos da ARTESP
- Ou consulte [Se√ß√£o 7.8]({{< relref "07-conversao-programatica#78-mesclagem-de-arquivos-geojson-m√∫ltiplas-geometrias" >}}) para o c√≥digo completo

---

### **üìò Documenta√ß√£o T√©cnica do Script**

Para detalhes t√©cnicos, c√≥digo-fonte completo e exemplos adicionais, consulte:

‚û°Ô∏è [Cap√≠tulo 7, Se√ß√£o 7.8 - Mesclagem de Arquivos GeoJSON]({{< relref "07-conversao-programatica#78-mesclagem-de-arquivos-geojson-m√∫ltiplas-geometrias" >}})

---

## **B. Exportar:**

**üìã Esta se√ß√£o se aplica se voc√™ tem UMA √öNICA camada.**

Se voc√™ passou pela Se√ß√£o A acima e j√° tem o arquivo mesclado, **pule esta se√ß√£o**.

---

1. **Selecione a camada** no painel de camadas (a que cont√©m suas geometrias finais)

   ‚ö†Ô∏è **Tem M√öLTIPLAS camadas (Point/LineString/Polygon separados)?**
   ‚Üí Volte para [Se√ß√£o A - M√∫ltiplas Camadas](#a-tratamento-de-m√∫ltiplas-camadas-com-geometrias-diferentes) acima!

   Esta se√ß√£o B √© apenas para quem tem UMA √∫nica camada.

2. Clique com **bot√£o direito** na camada ‚Üí **"Exportar ‚Üí Salvar Fei√ß√µes Como..."**

3. **Configure a exporta√ß√£o:**
   - **Formato**: **GeoJSON**
   - **Nome do arquivo**: `L13_conservacao_2026_R0.geojson` (ajuste conforme seu lote e tipo)
     - Para conserva√ß√£o: `L[n√∫mero]_conservacao_2026_R0.geojson`
     - Para obras: `L[n√∫mero]_obras_2026_R0.geojson`
   - **SRC**: **EPSG:4674 - SIRGAS 2000**
   - **Precis√£o de coordenadas**: **6** casas decimais
   - **Codifica√ß√£o**: UTF-8

4. Clique em **"OK"**

5. **Verifique:** Um arquivo `.geojson` deve ser criado no local especificado

---

## **B. Remover Colunas Auxiliares (se necess√°rio):**

Se voc√™ usou colunas auxiliares (`lat_ref`, `lon_ref`, `lon_inicio`, `lat_inicio`, `lon_fim`, `lat_fim`, ou `wkt`) durante o processo, essas colunas podem ter sido exportadas como propriedades. Voc√™ precisa remov√™-las do GeoJSON final.

**Como remover:**

1. **Abra o arquivo GeoJSON** em um editor de texto:
   - VS Code (recomendado)
   - Notepad++
   - Sublime Text

2. **Localize as propriedades auxiliares** dentro de cada feature:
   ```json
   "properties": {
     "id": "conserva-001",
     "lote": "L13",
     "lon_inicio": -46.6333,    ‚Üê REMOVER
     "lat_inicio": -23.5505,     ‚Üê REMOVER
     "lon_fim": -46.6345,        ‚Üê REMOVER
     "lat_fim": -23.5515,        ‚Üê REMOVER
     "wkt": "MULTIPOINT(...)",   ‚Üê REMOVER
     "rodovia": "SP0000280",
     ...
   }
   ```

3. **Delete essas linhas** para cada feature

4. **Salve o arquivo**

**üí° Dica:** Se voc√™ tem muitas features, use a funcionalidade de "Find & Replace" do VS Code:
- Procure por: `"lon_inicio":.*,\n` ou `"wkt":.*,\n`
- Substitua por: (vazio)
- Repita para cada coluna auxiliar

---

## **6.6 Passo 5: Adicionar Metadados e Ajustar Formato**

Abra o arquivo GeoJSON em um editor de texto e fa√ßa os seguintes ajustes.

**NOTA:** Se voc√™ usou [**Op√ß√£o 4 (ogr2ogr)**]({{< relref "06.4-metodo-ogr2ogr" >}}), voc√™ tamb√©m precisa remover o campo `name` e adicionar os campos `crs` e `metadata` conforme descrito na Op√ß√£o 4, se√ß√£o E.

---

### **6.6.1 Converter Campo `local` de String para Array (Obrigat√≥rio)**

O campo `local` no GeoJSON exportado estar√° como string delimitada por `;`. Voc√™ precisa convert√™-lo para array.

**De:**
```json
"local": "PISTA_NORTE;PISTA_SUL"
```

**Para:**
```json
"local": ["PISTA_NORTE", "PISTA_SUL"]
```

Escolha **uma das op√ß√µes** abaixo para fazer essa convers√£o:

---

#### **Op√ß√£o 1: Edi√ß√£o Manual** (para poucos registros)

Se voc√™ tem poucos registros, edite manualmente no editor de texto:

1. Localize cada ocorr√™ncia de `"local": "..."`
2. Substitua manualmente pela sintaxe de array

**Vantagens:** Simples, n√£o requer ferramentas adicionais
**Desvantagens:** Trabalhoso para muitos registros

---

#### **Op√ß√£o 2: Busca e Substitui√ß√£o com Regex no VS Code** (recomendado)

Use express√µes regulares no VS Code para convers√£o semiautom√°tica:

1. Abra o arquivo GeoJSON no **VS Code**
2. Pressione `Ctrl+H` (ou `Cmd+H` no Mac) para abrir Find & Replace
3. Clique no √≠cone `.*` para ativar **Regex**
4. Configure:
   - **Find**: `"local": "([^"]+)"`
   - **Replace**: `"local": "$1"`
5. **Revise manualmente** cada ocorr√™ncia e ajuste:
   - Para `PISTA_NORTE;PISTA_SUL` ‚Üí digite `["PISTA_NORTE", "PISTA_SUL"]`
   - Para `PISTA_NORTE` ‚Üí digite `["PISTA_NORTE"]`
   - Para campo vazio ‚Üí digite `[]`

**Vantagens:** Mais r√°pido que manual, com controle visual
**Desvantagens:** Requer ajuste manual de cada substitui√ß√£o

---

#### **Op√ß√£o 3: Script Python Autom√°tico** (mais confi√°vel)

Use um script Python para convers√£o autom√°tica e segura:

**Crie um arquivo chamado `converter_local.py`:**

```python
import json
import sys

def converter_local_para_array(arquivo_geojson):
    """
    Converte o campo 'local' de string delimitada por ';' para array.
    """
    print(f"Processando arquivo: {arquivo_geojson}")

    # Ler o arquivo GeoJSON
    with open(arquivo_geojson, 'r', encoding='utf-8') as f:
        data = json.load(f)

    # Processar cada feature
    count = 0
    for feature in data.get('features', []):
        local_value = feature['properties'].get('local', '')

        if isinstance(local_value, str):
            if local_value.strip():
                # Converter string delimitada em array
                feature['properties']['local'] = [
                    loc.strip() for loc in local_value.split(';') if loc.strip()
                ]
            else:
                # String vazia ‚Üí array vazio
                feature['properties']['local'] = []
            count += 1
        # Se j√° for array, manter como est√°

    # Salvar arquivo modificado
    with open(arquivo_geojson, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

    print(f"‚úÖ Convertidos {count} campos 'local' para array.")
    print(f"‚úÖ Arquivo atualizado: {arquivo_geojson}")

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Uso: python converter_local.py <arquivo.geojson>")
        print("Exemplo: python converter_local.py L13_conservacao_2026_R0.geojson")
        sys.exit(1)

    converter_local_para_array(sys.argv[1])
```

**Como usar:**

```bash
python converter_local.py L13_conservacao_2026_R0.geojson
```

**Vantagens:** Autom√°tico, confi√°vel, processa qualquer quantidade de registros
**Desvantagens:** Requer Python instalado

---

#### **Op√ß√£o 4: jq (Ferramenta CLI)** (para usu√°rios avan√ßados)

Se voc√™ tem `jq` instalado (ferramenta de processamento JSON via linha de comando):

**Instala√ß√£o do jq:**
- **Linux**: `sudo apt install jq` ou `sudo pacman -S jq`
- **Mac**: `brew install jq`
- **Windows**: Baixe em [https://stedolan.github.io/jq/](https://stedolan.github.io/jq/)

**Comando:**

```bash
jq '.features[].properties.local |= (
  if type == "string" then
    split(";") | map(gsub("^\\s+|\\s+$"; "")) | map(select(length > 0))
  else
    .
  end
)' arquivo.geojson > arquivo_convertido.geojson
```

**Ou sobrescrever o arquivo original:**

```bash
jq '.features[].properties.local |= (
  if type == "string" then
    split(";") | map(gsub("^\\s+|\\s+$"; "")) | map(select(length > 0))
  else
    .
  end
)' arquivo.geojson | sponge arquivo.geojson
```

*(requer `moreutils` para o comando `sponge`)*

**Vantagens:** Extremamente r√°pido, ideal para arquivos grandes
**Desvantagens:** Requer instala√ß√£o e conhecimento de jq

---

**üí° Recomenda√ß√£o:**
- **Poucos registros (< 10)**: Use **Op√ß√£o 1** (manual)
- **Registros m√©dios (10-100)**: Use **Op√ß√£o 2** (Regex no VS Code)
- **Muitos registros (> 100)**: Use **Op√ß√£o 3** (Script Python) ou **Op√ß√£o 4** (jq)

---

### **6.6.2 Adicionar Metadados ao Arquivo**

Logo ap√≥s a linha `"type": "FeatureCollection",`, adicione:

```json
"crs": {
  "type": "name",
  "properties": {
    "name": "urn:ogc:def:crs:EPSG::4674"
  }
},
"metadata": {
  "schema_version": "R0",
  "data_geracao": "2025-11-08T10:30:00-03:00"
},
```

**Ajuste a data em `data_geracao`** para a data/hora atual.

**Ferramentas de edi√ß√£o JSON recomendadas:**
- **VS Code** com extens√£o "JSON Tools"
- **Notepad++** com plugin JSON Viewer
- **JSONLint** (online): [https://jsonlint.com/](https://jsonlint.com/)

---

## **6.7 Passo 6: Validar o Arquivo**

Ap√≥s criar e ajustar o GeoJSON, **valide-o** usando o script fornecido pela ARTESP:

```bash
# Baixe o script validar_geojson.py e os schemas do Portal de Dados Abertos
# Execute:
python validar_geojson.py schemas/conserva.schema.r0.json L13_conservacao_2026_R0.geojson
```

**Ou use ferramentas online:**
- [GeoJSONLint](https://geojsonlint.com/)
- [JSON Schema Validator](https://www.jsonschemavalidator.net/)

O script verificar√°:
- ‚úÖ Conformidade com o schema
- ‚úÖ Unicidade dos IDs
- ‚úÖ Formato dos campos
- ‚úÖ CRS correto
- ‚úÖ Geometrias v√°lidas

---

**üéâ Parab√©ns!** Se a valida√ß√£o passou, seu arquivo GeoJSON est√° pronto para envio √† ARTESP.
